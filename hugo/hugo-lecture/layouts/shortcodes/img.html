{{ $src     := .Get "src"     | default "" }}
{{ $caption := .Get "caption" | default "" }}
{{ $width   := .Get "width"   | default "auto"}}
{{ $height  := .Get "height"  | default "auto"}}
{{ $class   := .Get "class"   | default "" }}

{{ $src = urls.Parse $src }}
{{ if $src.Scheme }}
    {{ $src = $src.String }}
{{ else }}
    {{ $src = $src.Path }}
    {{ with (strings.TrimPrefix "/" $.Page.File.Dir) }}
        {{/* if not on "home" page: use path to file */}}
        {{ $src = printf "%s/%s" . $src }}
    {{ end }}
    {{ $src = $src | path.Clean | absURL }}

    {{ if $.Site.IsMultiLingual }}
        {{/*
            Hugo will include the current language code as subdir in the URL, but the
            additional content (images, files, ...) will be placed in the default
            language dir only. So the content will not be reachable using the correct
            URL generated by Hugo, and we have to use the URL pointing to the default
            language dir in all language variants.

            Replace the current language code in the path with the language code for the
            default language, e.g. replace "/ma/" w/ "/ba/" in "path/ma/images/wuppie.png"
            (result: "path/ba/images/wuppie.png").
        */}}
        {{ $default_lang := printf "/%s/" (index $.Site.Languages 0).Lang }}
        {{ $current_lang := printf "%s/" $.Site.LanguagePrefix }}
        {{ $src = replace $src $current_lang $default_lang }}
    {{ end }}
{{ end }}

{{/*
    Emulating the native Hugo shortcode "{{% figure src="..." caption="..." width="..." height="..." class="..." %}}"
*/}}
{{ with $src }}
<figure class="{{- $class -}}">
    <img src="{{- $src | safeURL -}}" alt="{{- $caption -}}" width="{{- $width -}}" height="{{- $height -}}">
    <figcaption><p>{{- $caption | markdownify -}}</p></figcaption>
</figure>
{{ end }}
